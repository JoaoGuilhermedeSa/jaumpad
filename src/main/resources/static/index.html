<!DOCTYPE html>
<html>
<head>
<title>JaumPad WebSocket Test</title>
<script
	src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
	<h1>JaumPad</h1>

	<label for="noteId">Enter Note ID:</label>
	<input type="text" id="noteId" placeholder="e.g. WSWEEIUFAS">
	<button onclick="connect()">Load Note</button>

	<br>
	<br>

	<textarea id="noteArea" rows="15" cols="80" disabled></textarea>

	<script>
        let stompClient;
        let currentId = "";

        function connect() {
            currentId = document.getElementById("noteId").value.trim();
            if (!currentId) {
                alert("Please enter a Note ID.");
                return;
            }


            fetch(`/api/notes/${currentId}`)
                .then(res => res.json())
                .then(note => {
                    document.getElementById("noteArea").value = note.content;
                    document.getElementById("noteArea").disabled = false;
                });

            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function () {
                console.log('Connected via WebSocket');

                // Unsubscribe previous if any
                if (stompClient.subscriptions[`/topic/notes/${currentId}`]) {
                    stompClient.unsubscribe(`/topic/notes/${currentId}`);
                }

                stompClient.subscribe(`/topic/notes/${noteId}`, function (message) {
                    console.log("Raw message:", message.body);
                    const note = JSON.parse(message.body);
                    document.getElementById("noteArea").value = note.content;
                });

                document.getElementById("noteArea").addEventListener("input", function () {
                    const content = this.value;
                    stompClient.send(`/app/notes/${currentId}`, {}, content);
                });
            });
        }
    </script>
</body>
</html>